---
- hosts: servers
  become: true

  tasks:

  - name: Disable Nouveau Driver
    include_role:
      name: nouveau-blacklist
    when:
      (gpu | bool) and
      (gpu_type == 'nvidia')

  - name: Install Nvidia Drivers
    include_role:
      name: nvidia-driver-install
    when:
      (gpu | bool) and
      (gpu_type == 'nvidia')

  #TODO: Do we need OCI hooks or something else to enable radeon containers like nvidia?
  #TODO: What is needed if using docker instead of podman
  - name: Install Nvidia OCI Hooks
    include_role:
      name: nvidia-container-runtime-hook
    when:
      (gpu | bool) and
      (gpu_type == 'nvidia') and
      (podman | bool)

  - name: Install Radeon Drivers
    include_role:
      name: radeon-driver-install
    when:
      (gpu | bool) and
      (gpu_type == 'radeon')

  - name: Populate service facts
    service_facts:
    tags: always

  - include_role:
      name: fahclient
  
  - name: Install and run fahclient with docker
    include_role:
      name: docker
    when:
      docker | bool

  - name: Install and run fahclient with podman
    include_role:
      name: podman
    when:
      (podman | bool)

...
